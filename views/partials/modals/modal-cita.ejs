<!-- MODAL CREAR/EDITAR CITA -->
<div
  id="modalCita"
  class="hidden fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center z-50"
>
  <div class="bg-white/90 rounded-2xl shadow-xl w-[90%] max-w-2xl p-6 relative border border-[#E0E6E6]">
    <h2 id="modalCitaTitulo" class="text-2xl font-bold text-[#3F4A4C] mb-4">Registrar nueva cita</h2>

    <form id="formCita" action="/citas" method="POST" class="space-y-4">
      <input type="hidden" id="citaId" name="id" />
      
      <!-- PACIENTE -->
      <div>
        <label class="text-sm font-medium text-[#3F4A4C]">Paciente</label>
        <select
          id="citaPacienteId"
          name="paciente_id"
          required
          class="w-full px-3 py-2 rounded-xl border border-[#E0E6E6] bg-white/70 outline-none focus:ring-2 focus:ring-[#A7D9B8]"
        >
          <option value="">Seleccione un paciente</option>
          <% if (pacientes && pacientes.length > 0) { %>
            <% pacientes.forEach(p => { %>
              <option value="<%= p.id %>"><%= p.nombre %> <%= p.apellido %> - <%= p.dni %></option>
            <% }) %>
          <% } %>
        </select>
      </div>

      <!-- MÉDICO -->
      <div>
        <label class="text-sm font-medium text-[#3F4A4C]">Médico</label>
        <select
          id="citaMedicoId"
          name="medico_id"
          required
          class="w-full px-3 py-2 rounded-xl border border-[#E0E6E6] bg-white/70 outline-none focus:ring-2 focus:ring-[#A7D9B8]"
        >
          <option value="">Seleccione un médico</option>
          <% if (medicos && medicos.length > 0) { %>
            <% medicos.forEach(m => { %>
              <option value="<%= m.id %>"><%= m.nombre %> <%= m.apellido %> - <%= m.especialidad %></option>
            <% }) %>
          <% } %>
        </select>
      </div>

      <!-- FECHA Y HORA -->
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="text-sm font-medium text-[#3F4A4C]">Fecha</label>
          <input
            id="citaFecha"
            type="date"
            name="fecha"
            required
            class="w-full px-3 py-2 rounded-xl border border-[#E0E6E6] bg-white/70 outline-none focus:ring-2 focus:ring-[#A7D9B8]"
            min="<%= new Date().toISOString().split('T')[0] %>"
          />
        </div>

        <div>
          <label class="text-sm font-medium text-[#3F4A4C]">Hora</label>
          <select
            id="citaHora"
            name="hora"
            required
            class="w-full px-3 py-2 rounded-xl border border-[#E0E6E6] bg-white/70 outline-none focus:ring-2 focus:ring-[#A7D9B8]"
          >
            <option value="">Seleccione hora</option>
            <option value="08:00:00">08:00 - 09:00 AM</option>
            <option value="09:00:00">09:00 - 10:00 AM</option>
            <option value="10:00:00">10:00 - 11:00 AM</option>
            <option value="11:00:00">11:00 - 12:00 PM</option>
            <option value="13:00:00">01:00 - 02:00 PM</option>
            <option value="14:00:00">02:00 - 03:00 PM</option>
            <option value="15:00:00">03:00 - 04:00 PM</option>
            <option value="16:00:00">04:00 - 05:00 PM</option>
          </select>
        </div>
      </div>

      <!-- MOTIVO -->
      <div>
        <label class="text-sm font-medium text-[#3F4A4C]">Motivo</label>
        <textarea
          id="citaMotivo"
          name="motivo"
          rows="2"
          placeholder="Ejemplo: chequeo anual, control postoperatorio..."
          class="w-full px-3 py-2 rounded-xl border border-[#E0E6E6] bg-white/70 outline-none focus:ring-2 focus:ring-[#A7D9B8]"
        ></textarea>
      </div>

      <!-- ESTADO (solo al editar) -->
      <div id="citaEstadoContainer" class="hidden">
        <label class="text-sm font-medium text-[#3F4A4C]">Estado</label>
        <select
          id="citaEstado"
          name="estado"
          class="w-full px-3 py-2 rounded-xl border border-[#E0E6E6] bg-white/70 outline-none focus:ring-2 focus:ring-[#A7D9B8]"
        >
          <option value="programada">Programada</option>
          <option value="confirmada">Confirmada</option>
          <option value="cancelada">Cancelada</option>
          <option value="atendida">Atendida</option>
          <option value="no_show">No asistió</option>
        </select>
      </div>

      <!-- BOTONES -->
      <div class="flex justify-end gap-4 pt-4">
        <button
          type="button"
          id="btnCerrarModalCita"
          class="px-4 py-2 rounded-xl border border-[#E0E6E6] bg-white/70 hover:bg-[#E0E6E6]/70 text-[#3F4A4C]"
        >
          Cancelar
        </button>
        <button
          type="submit"
          class="px-4 py-2 rounded-xl bg-[#A7D9B8] hover:bg-[#3F4A4C] text-white font-semibold"
        >
          Guardar cita
        </button>
      </div>
    </form>
  </div>
</div>

<!-- SCRIPT DE CONTROL -->
<script>
  const modalCita = document.getElementById("modalCita");
  const btnAddCita = document.getElementById("btnAddCita");
  const btnCerrarModalCita = document.getElementById("btnCerrarModalCita");
  const formCita = document.getElementById("formCita");
  const tituloCita = document.getElementById("modalCitaTitulo");
  const estadoContainer = document.getElementById("citaEstadoContainer");

  // Abrir modal para crear
  if (btnAddCita) {
    btnAddCita.addEventListener("click", () => {
      formCita.action = "/citas";
      formCita.reset();
      tituloCita.textContent = "Registrar nueva cita";
      estadoContainer.classList.add("hidden");
      modalCita.classList.remove("hidden");
    });
  }

  // Abrir modal para editar
  window.editarCita = (cita) => {
    formCita.action = `/citas/editar/${cita.id}`;
    tituloCita.textContent = "Editar cita";
    
    document.getElementById("citaId").value = cita.id;
    document.getElementById("citaPacienteId").value = cita.paciente_id;
    document.getElementById("citaMedicoId").value = cita.medico_id;
    document.getElementById("citaFecha").value = cita.fecha;
    document.getElementById("citaHora").value = cita.hora;
    document.getElementById("citaMotivo").value = cita.motivo || '';
    document.getElementById("citaEstado").value = cita.estado;
    
    estadoContainer.classList.remove("hidden");
    modalCita.classList.remove("hidden");
  };

  if (btnCerrarModalCita) {
    btnCerrarModalCita.addEventListener("click", () => modalCita.classList.add("hidden"));
  }
</script>
