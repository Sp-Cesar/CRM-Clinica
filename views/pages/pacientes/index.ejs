<div class="space-y-8">
  <!-- Encabezado -->
  <header class="flex items-center justify-between">
    <div>
      <h1 class="text-3xl font-bold text-[#3F4A4C]">Pacientes üßë‚Äç‚öïÔ∏è</h1>
      <p class="text-sm text-[#3F4A4C]/70">Gesti√≥n y control de pacientes registrados</p>
    </div>

    <button
      id="btnAddPaciente"
      class="bg-[#A7D9B8] hover:bg-[#3F4A4C] hover:text-white text-[#3F4A4C] font-semibold px-5 py-2 rounded-xl shadow transition"
    >
      + Nuevo paciente
    </button>
  </header>

  <!-- Filtros Avanzados -->
  <div class="space-y-4">
    <!-- B√∫squeda principal -->
    <form method="GET" action="/pacientes" class="flex flex-wrap gap-4 items-center">
      <div class="relative flex-1 min-w-[300px]">
        <input
          type="text"
          name="q"
          id="busquedaPacientes"
          value="<%= typeof busqueda !== 'undefined' ? busqueda : '' %>"
          placeholder="Buscar por nombre, apellido, DNI, tel√©fono o email..."
          class="w-full px-4 py-2 pl-10 rounded-xl border border-[#E0E6E6] bg-white/60 backdrop-blur-md outline-none focus:ring-2 focus:ring-[#A7D9B8]"
        />
        <div class="absolute left-3 top-2.5 text-gray-400">
          üîç
        </div>
        <!-- Dropdown de sugerencias -->
        <div id="sugerenciasPacientes" class="hidden absolute z-50 w-full mt-1 bg-white rounded-xl shadow-lg border border-[#E0E6E6] max-h-60 overflow-y-auto">
          <!-- Las sugerencias se cargar√°n aqu√≠ din√°micamente -->
        </div>
      </div>
      <button
        type="submit"
        class="px-5 py-2 rounded-xl bg-[#A7D9B8] hover:bg-[#3F4A4C] text-white font-semibold shadow transition"
      >
        Buscar
      </button>
      <button
        type="button"
        onclick="limpiarFiltros()"
        class="px-4 py-2 rounded-xl border border-[#E0E6E6] bg-white/60 hover:bg-gray-100 text-gray-600 transition"
      >
        Limpiar
      </button>
    </form>

    <!-- Filtros adicionales -->
    <div class="flex flex-wrap gap-4 items-center text-sm">
      <div class="flex items-center gap-2">
        <span class="text-gray-600">Filtros r√°pidos:</span>
        <a href="/pacientes?q=" class="px-3 py-1 <%= !recientesFiltro && !sinCitasFiltro ? 'bg-[#A7D9B8] text-white' : 'bg-gray-100 hover:bg-gray-200' %> rounded-lg transition">Todos</a>
        <a href="/pacientes?recientes=1" class="px-3 py-1 <%= recientesFiltro === '1' ? 'bg-blue-600 text-white' : 'bg-blue-100 hover:bg-blue-200 text-blue-700' %> rounded-lg transition">Recientes</a>
        <a href="/pacientes?sin_citas=1" class="px-3 py-1 <%= sinCitasFiltro === '1' ? 'bg-yellow-600 text-white' : 'bg-yellow-100 hover:bg-yellow-200 text-yellow-700' %> rounded-lg transition">Sin citas</a>
      </div>
    </div>
  </div>

  <% if (busqueda || recientesFiltro || sinCitasFiltro) { %>
    <div class="flex items-center gap-4 text-sm text-[#3F4A4C]/70">
      <% if (busqueda) { %>
        <span>B√∫squeda: <strong><%= busqueda %></strong></span>
      <% } %>
      <% if (recientesFiltro === '1') { %>
        <span>Filtro: <strong>Pacientes Recientes</strong></span>
      <% } %>
      <% if (sinCitasFiltro === '1') { %>
        <span>Filtro: <strong>Sin Citas</strong></span>
      <% } %>
    </div>
  <% } %>


  <!-- Tabla de pacientes -->
  <div class="overflow-x-auto rounded-2xl bg-white/60 backdrop-blur-md shadow-lg border border-[#E0E6E6]">
    <table class="w-full text-sm text-[#3F4A4C]">
      <thead class="bg-[#A7D9B8]/70 text-[#3F4A4C] font-semibold uppercase tracking-wide">
        <tr>
          <th class="px-6 py-3 text-left">#</th>
          <th class="px-6 py-3 text-left">DNI</th>
          <th class="px-6 py-3 text-left">Nombre</th>
          <th class="px-6 py-3 text-left">Apellido</th>
          <th class="px-6 py-3 text-left">Edad</th>
          <th class="px-6 py-3 text-left">Tel√©fono</th>
          <th class="px-6 py-3 text-left">Email</th>
          <th class="px-6 py-3 text-left">Direcci√≥n</th>
          <th class="px-6 py-3 text-center">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <% if (pacientes && pacientes.length > 0) { %>
          <% pacientes.forEach((p, i) => { %>
            <tr class="border-t border-[#E0E6E6]/60 hover:bg-[#E0E6E6]/40 transition">
              <td class="px-6 py-3"><%= i + 1 %></td>
              <td class="px-6 py-3"><%= p.dni %></td>
              <td class="px-6 py-3 font-semibold"><%= p.nombre %></td>
              <td class="px-6 py-3"><%= p.apellido %></td>
              <td class="px-6 py-3"><%= p.edad ? p.edad + ' a√±os' : '-' %></td>
              <td class="px-6 py-3"><%= p.telefono || '-' %></td>
              <td class="px-6 py-3"><%= p.email || '-' %></td>
              <td class="px-6 py-3"><%= p.direccion || '-' %></td>
              <td class="px-6 py-3 text-center space-x-2">
                <button onclick='editarPaciente(<%= JSON.stringify(p) %>)' class="text-[#489FB5] font-semibold hover:underline">Editar</button>
                <button onclick='confirmarEliminacion("/pacientes/eliminar/<%= p.id %>", "paciente", "<%= p.nombre %> <%= p.apellido %>")' class="text-red-500 font-semibold hover:underline">Eliminar</button>
              </td>
            </tr>
          <% }) %>
        <% } else { %>
          <tr>
            <td colspan="9" class="text-center py-6 text-gray-500">No hay pacientes registrados.</td>
          </tr>
        <% } %>
      </tbody>
    </table>
  </div>
</div>

<!-- Modal -->
<%- include('../../partials/modals/modal-paciente') %>

<!-- Script para b√∫squeda mejorada -->
<script>
  // Variables globales
  let timeoutBusqueda;
  const busquedaInput = document.getElementById('busquedaPacientes');
  const sugerenciasDropdown = document.getElementById('sugerenciasPacientes');

  // Funci√≥n para obtener sugerencias de pacientes
  async function obtenerSugerenciasPacientes(termino) {
    if (termino.length < 2) {
      ocultarSugerencias();
      return;
    }

    try {
      const response = await fetch(`/api/autocompletado?q=${encodeURIComponent(termino)}&tipo=pacientes`);
      const data = await response.json();
      
      if (data.sugerencias && data.sugerencias.length > 0) {
        mostrarSugerenciasPacientes(data.sugerencias);
      } else {
        ocultarSugerencias();
      }
    } catch (error) {
      console.error('Error al obtener sugerencias:', error);
      ocultarSugerencias();
    }
  }

  // Funci√≥n para mostrar sugerencias
  function mostrarSugerenciasPacientes(sugerencias) {
    sugerenciasDropdown.innerHTML = '';
    
    sugerencias.forEach(sugerencia => {
      const item = document.createElement('div');
      item.className = 'px-4 py-2 hover:bg-[#A7D9B8]/20 cursor-pointer flex items-center gap-3 border-b border-gray-100 last:border-b-0';
      item.innerHTML = `
        <span class="text-lg">üë§</span>
        <div class="flex-1">
          <div class="font-medium text-[#3F4A4C]">${sugerencia.texto}</div>
          <div class="text-xs text-gray-500">DNI: ${sugerencia.dni}</div>
        </div>
      `;
      
      item.addEventListener('click', () => {
        busquedaInput.value = sugerencia.texto;
        ocultarSugerencias();
        // Auto-submit del formulario
        busquedaInput.closest('form').submit();
      });
      
      sugerenciasDropdown.appendChild(item);
    });
    
    sugerenciasDropdown.classList.remove('hidden');
  }

  // Funci√≥n para ocultar sugerencias
  function ocultarSugerencias() {
    sugerenciasDropdown.classList.add('hidden');
  }

  // Funci√≥n para limpiar filtros
  function limpiarFiltros() {
    busquedaInput.value = '';
    window.location.href = '/pacientes';
  }

  // Event listeners
  if (busquedaInput) {
    // B√∫squeda con debounce
    busquedaInput.addEventListener('input', (e) => {
      clearTimeout(timeoutBusqueda);
      timeoutBusqueda = setTimeout(() => {
        obtenerSugerenciasPacientes(e.target.value);
      }, 300);
    });

    // Ocultar sugerencias al hacer clic fuera
    document.addEventListener('click', (e) => {
      if (!busquedaInput.contains(e.target) && !sugerenciasDropdown.contains(e.target)) {
        ocultarSugerencias();
      }
    });

    // Ocultar sugerencias al perder foco
    busquedaInput.addEventListener('blur', () => {
      setTimeout(ocultarSugerencias, 200);
    });
  }
</script>
