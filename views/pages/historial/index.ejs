<div class="space-y-8">
  <!-- Encabezado -->
  <header class="flex items-center justify-between">
    <div>
      <h1 class="text-3xl font-bold text-[#3F4A4C]">Historial de Atenciones üìã</h1>
      <p class="text-sm text-[#3F4A4C]/70">Registro de consultas y diagn√≥sticos m√©dicos</p>
    </div>

    <button
      id="btnAddHistorial"
      class="bg-[#A7D9B8] hover:bg-[#3F4A4C] hover:text-white text-[#3F4A4C] font-semibold px-5 py-2 rounded-xl shadow transition"
    >
      + Nueva atenci√≥n
    </button>
  </header>

  <!-- FILTROS AVANZADOS -->
  <div class="space-y-4">
    <!-- B√∫squeda de texto -->
    <form method="GET" action="/historial" class="flex flex-wrap gap-4 items-center">
      <div class="relative flex-1 min-w-[300px]">
        <input
          type="text"
          name="q"
          id="busquedaHistorial"
          value="<%= typeof busqueda !== 'undefined' ? busqueda : '' %>"
          placeholder="Buscar por paciente, m√©dico, diagn√≥stico, observaciones o tratamiento..."
          class="w-full px-4 py-2 pl-10 rounded-xl border border-[#E0E6E6] bg-white/60 backdrop-blur-md outline-none focus:ring-2 focus:ring-[#A7D9B8]"
        />
        <div class="absolute left-3 top-2.5 text-gray-400">
          üîç
        </div>
        <!-- Dropdown de sugerencias -->
        <div id="sugerenciasHistorial" class="hidden absolute z-50 w-full mt-1 bg-white rounded-xl shadow-lg border border-[#E0E6E6] max-h-60 overflow-y-auto">
          <!-- Las sugerencias se cargar√°n aqu√≠ din√°micamente -->
        </div>
      </div>
      <button
        type="submit"
        class="px-5 py-2 rounded-xl bg-[#A7D9B8] hover:bg-[#3F4A4C] text-white font-semibold shadow transition"
      >
        Buscar
      </button>
      <button
        type="button"
        onclick="limpiarFiltros()"
        class="px-4 py-2 rounded-xl border border-[#E0E6E6] bg-white/60 hover:bg-gray-100 text-gray-600 transition"
      >
        Limpiar
      </button>
    </form>

    <!-- Filtros espec√≠ficos -->
    <form method="GET" action="/historial" class="flex flex-wrap gap-4 items-center">
      <select
        name="paciente_id"
        class="px-4 py-2 rounded-xl border border-[#E0E6E6] bg-white/60 backdrop-blur-md outline-none focus:ring-2 focus:ring-[#A7D9B8]"
      >
        <option value="">Todos los pacientes</option>
        <% if (pacientes && pacientes.length > 0) { %>
          <% pacientes.forEach(p => { %>
            <option value="<%= p.id %>" <%= pacienteFiltro == p.id ? 'selected' : '' %>>
              <%= p.nombre %> <%= p.apellido %> - <%= p.dni %>
            </option>
          <% }) %>
        <% } %>
      </select>

      <select
        name="medico_id"
        class="px-4 py-2 rounded-xl border border-[#E0E6E6] bg-white/60 backdrop-blur-md outline-none focus:ring-2 focus:ring-[#A7D9B8]"
      >
        <option value="">Todos los m√©dicos</option>
        <% if (medicos && medicos.length > 0) { %>
          <% medicos.forEach(m => { %>
            <option value="<%= m.id %>" <%= medicoFiltro == m.id ? 'selected' : '' %>>
              <%= m.nombre %> <%= m.apellido %> - <%= m.especialidad %>
            </option>
          <% }) %>
        <% } %>
      </select>

      <button
        type="submit"
        class="px-5 py-2 rounded-xl bg-[#A7D9B8] hover:bg-[#3F4A4C] text-white font-semibold shadow transition"
      >
        Filtrar
      </button>
    </form>

    <!-- Filtros r√°pidos -->
    <div class="flex flex-wrap gap-4 items-center text-sm">
      <div class="flex items-center gap-2">
        <span class="text-gray-600">Filtros r√°pidos:</span>
        <a href="/historial?q=" class="px-3 py-1 <%= !recientesFiltro && !conDiagnosticoFiltro && !conTratamientoFiltro ? 'bg-[#A7D9B8] text-white' : 'bg-gray-100 hover:bg-gray-200' %> rounded-lg transition">Todos</a>
        <a href="/historial?recientes=1" class="px-3 py-1 <%= recientesFiltro === '1' ? 'bg-blue-600 text-white' : 'bg-blue-100 hover:bg-blue-200 text-blue-700' %> rounded-lg transition">Recientes</a>
        <a href="/historial?con_diagnostico=1" class="px-3 py-1 <%= conDiagnosticoFiltro === '1' ? 'bg-green-600 text-white' : 'bg-green-100 hover:bg-green-200 text-green-700' %> rounded-lg transition">Con diagn√≥stico</a>
        <a href="/historial?con_tratamiento=1" class="px-3 py-1 <%= conTratamientoFiltro === '1' ? 'bg-yellow-600 text-white' : 'bg-yellow-100 hover:bg-yellow-200 text-yellow-700' %> rounded-lg transition">Con tratamiento</a>
      </div>
    </div>
  </div>

  <% if (busqueda || recientesFiltro || conDiagnosticoFiltro || conTratamientoFiltro) { %>
    <div class="flex items-center gap-4 text-sm text-[#3F4A4C]/70">
      <% if (busqueda) { %>
        <span>B√∫squeda: <strong><%= busqueda %></strong></span>
      <% } %>
      <% if (recientesFiltro === '1') { %>
        <span>Filtro: <strong>Historial Reciente</strong></span>
      <% } %>
      <% if (conDiagnosticoFiltro === '1') { %>
        <span>Filtro: <strong>Con Diagn√≥stico</strong></span>
      <% } %>
      <% if (conTratamientoFiltro === '1') { %>
        <span>Filtro: <strong>Con Tratamiento</strong></span>
      <% } %>
    </div>
  <% } %>

  <!-- Tabla de historial -->
  <div class="overflow-x-auto rounded-2xl bg-white/60 backdrop-blur-md shadow-lg border border-[#E0E6E6]">
    <table class="w-full text-sm text-[#3F4A4C]">
      <thead class="bg-[#A7D9B8]/70 text-[#3F4A4C] font-semibold uppercase tracking-wide">
        <tr>
          <th class="px-6 py-3 text-left">#</th>
          <th class="px-6 py-3 text-left">Fecha</th>
          <th class="px-6 py-3 text-left">Paciente</th>
          <th class="px-6 py-3 text-left">M√©dico</th>
          <th class="px-6 py-3 text-left">Diagn√≥stico</th>
          <th class="px-6 py-3 text-left">Observaciones</th>
          <th class="px-6 py-3 text-left">Tratamiento</th>
          <th class="px-6 py-3 text-center">Acciones</th>
        </tr>
      </thead>

      <tbody>
        <% if (historiales && historiales.length > 0) { %>
          <% historiales.forEach((h, i) => { %>
            <tr class="border-t border-[#E0E6E6]/60 hover:bg-[#E0E6E6]/40 transition">
              <td class="px-6 py-3"><%= i + 1 %></td>
              <td class="px-6 py-3">
                <%= new Date(h.fecha_atencion).toLocaleDateString('es-PE') %>
              </td>
              <td class="px-6 py-3 font-semibold">
                <a href="/historial/paciente/<%= h.paciente_id %>" class="text-[#489FB5] hover:underline">
                  <%= h.paciente_nombre %> <%= h.paciente_apellido %>
                </a>
              </td>
              <td class="px-6 py-3">
                <%= h.medico_nombre %> <%= h.medico_apellido %><br/>
                <span class="text-xs text-gray-500"><%= h.medico_especialidad %></span>
              </td>
              <td class="px-6 py-3">
                <%= h.diagnostico.substring(0, 50) %><%= h.diagnostico.length > 50 ? '...' : '' %>
              </td>
              <td class="px-6 py-3">
                <%= h.observaciones ? h.observaciones.substring(0, 30) : '-' %><%= h.observaciones && h.observaciones.length > 30 ? '...' : '' %>
              </td>
              <td class="px-6 py-3">
                <%= h.tratamiento ? h.tratamiento.substring(0, 30) : '-' %><%= h.tratamiento && h.tratamiento.length > 30 ? '...' : '' %>
              </td>
              <td class="px-6 py-3 text-center space-x-2">
                <a href="/historial/eliminar/<%= h.id %>" class="text-red-500 font-semibold hover:underline" onclick="return confirm('¬øEst√°s seguro de eliminar este registro?')">Eliminar</a>
              </td>
            </tr>
          <% }) %>
        <% } else { %>
          <tr>
            <td colspan="8" class="text-center py-6 text-gray-500">No hay registros de atenciones.</td>
          </tr>
        <% } %>
      </tbody>
    </table>
  </div>

  <!-- Modal -->
  <%- include('../../partials/modals/modal-historial') %>
</div>

